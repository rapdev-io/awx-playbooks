---
- name: Install Rubrik
  hosts: all
  gather_facts: false
  tasks:
    - name: Create Temp Location
      win_file:
        path: C:\Temp
        state: directory

    - name: Download Zip
      win_get_url:
        url: "https://{{ rubrik_cluster_ip }}/connector/RubrikBackupService.zip"
        dest: C:\Temp\RubrikBackupService.zip
        validate_certs: no
        force: no

    - name: Extract Zip
      win_unzip:
        src: C:\Temp\RubrikBackupService.zip
        dest: C:\Temp\

    - name: Install Connector
      win_package:
        path: C:\Temp\RubrikBackupService.msi
        state: present
        creates_service: 'Rubrik Backup Service'
        wait: yes

    - name: Set Logon for Connector
      win_service:
        username: "{{ rubrik_svc_user }}"
        password: "{{ rubrik_svc_password }}"
        name: 'Rubrik Backup Service'
